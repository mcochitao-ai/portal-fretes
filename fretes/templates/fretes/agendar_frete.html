{% extends 'fretes/base.html' %}

{% block title %}Agendar Frete #{{ frete.id }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="header header-renner">
    <div class="header-content">
        <h1>Agendar Frete #{{ frete.id }}</h1>
        <div class="subtitle">Preencha os dados do ve√≠culo e motorista para agendar o frete</div>
    </div>
</div>

<div class="container mx-auto px-4 py-8">

    <!-- Informa√ß√µes do Frete -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 mb-8">
        <div class="p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Informa√ß√µes do Frete</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">üìç Origem</h3>
                    <p class="text-gray-600">
                        {% if frete.origem %}
                            {{ frete.origem.nome }}<br>
                            <small>{{ frete.origem.endereco_completo }}</small>
                        {% else %}
                            <span class="text-gray-400">N√£o informada</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">üéØ Destinos</h3>
                    {% for destino in destinos %}
                        <p class="text-gray-600">
                            {{ destino.cidade }}/{{ destino.estado }}<br>
                            <small>Vol: {{ destino.volume }}</small>
                        </p>
                    {% endfor %}
                </div>
            </div>
            
            {% if frete.valor_total %}
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-2">üí∞ Valor Total</h3>
                    <p class="text-2xl font-bold text-green-600">R$ {{ frete.valor_total|floatformat:2 }}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Formul√°rio de Agendamento -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200">
        <div class="p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">üöö Dados do Ve√≠culo e Motorista</h2>
            
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Dados do Ve√≠culo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="placa_veiculo" class="block text-sm font-medium text-gray-700 mb-2">
                            Placa do Ve√≠culo *
                        </label>
                        <input type="text" id="placa_veiculo" name="placa_veiculo" 
                               class="form-control" placeholder="ABC-1234" required
                               maxlength="10" style="text-transform: uppercase;">
                    </div>
                    <div>
                        <label for="modelo_veiculo" class="block text-sm font-medium text-gray-700 mb-2">
                            Modelo do Ve√≠culo *
                        </label>
                        <input type="text" id="modelo_veiculo" name="modelo_veiculo" 
                               class="form-control" placeholder="Ex: Mercedes-Benz Actros" required>
                    </div>
                    <div>
                        <label for="cor_veiculo" class="block text-sm font-medium text-gray-700 mb-2">
                            Cor do Ve√≠culo *
                        </label>
                        <input type="text" id="cor_veiculo" name="cor_veiculo" 
                               class="form-control" placeholder="Ex: Branco" required>
                    </div>
                </div>

                <!-- Dados do Motorista -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="motorista_nome" class="block text-sm font-medium text-gray-700 mb-2">
                            Nome do Motorista *
                        </label>
                        <input type="text" id="motorista_nome" name="motorista_nome" 
                               class="form-control" placeholder="Nome completo" required>
                    </div>
                    <div>
                        <label for="motorista_cpf" class="block text-sm font-medium text-gray-700 mb-2">
                            CPF do Motorista *
                        </label>
                        <input type="text" id="motorista_cpf" name="motorista_cpf" 
                               class="form-control" placeholder="000.000.000-00" required
                               maxlength="14">
                    </div>
                    <div>
                        <label for="motorista_telefone" class="block text-sm font-medium text-gray-700 mb-2">
                            Telefone do Motorista *
                        </label>
                        <input type="tel" id="motorista_telefone" name="motorista_telefone" 
                               class="form-control" placeholder="(11) 99999-9999" required>
                    </div>
                </div>

                <!-- Datas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="data_coleta" class="block text-sm font-medium text-gray-700 mb-2">
                            Data/Hora da Coleta *
                        </label>
                        <input type="datetime-local" id="data_coleta" name="data_coleta" 
                               class="form-control" required>
                    </div>
                    <div>
                        <label for="data_entrega_prevista" class="block text-sm font-medium text-gray-700 mb-2">
                            Data/Hora Prevista de Entrega *
                        </label>
                        <input type="datetime-local" id="data_entrega_prevista" name="data_entrega_prevista" 
                               class="form-control" required>
                    </div>
                </div>

                <!-- Observa√ß√µes -->
                <div>
                    <label for="observacoes_agendamento" class="block text-sm font-medium text-gray-700 mb-2">
                        Observa√ß√µes do Agendamento
                    </label>
                    <textarea id="observacoes_agendamento" name="observacoes_agendamento" 
                              class="form-control" rows="3" 
                              placeholder="Observa√ß√µes adicionais sobre o agendamento..."></textarea>
                </div>

                <!-- Bot√µes -->
                <div class="flex justify-end gap-4 pt-6 border-t border-gray-200">
                    <a href="{% url 'fretes_para_agendamento' %}" class="btn btn-outline">
                        Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        üìÖ Agendar Frete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Formata√ß√£o autom√°tica dos campos
document.getElementById('placa_veiculo').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});

document.getElementById('motorista_cpf').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d)/, '$1.$2');
    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    e.target.value = value;
});

document.getElementById('motorista_telefone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/(\d{2})(\d)/, '($1) $2');
    value = value.replace(/(\d{5})(\d)/, '$1-$2');
    e.target.value = value;
});

// Definir data m√≠nima para hoje
const today = new Date().toISOString().slice(0, 16);
document.getElementById('data_coleta').min = today;
document.getElementById('data_entrega_prevista').min = today;

// Validar que a data de entrega seja posterior √† coleta
document.getElementById('data_coleta').addEventListener('change', function() {
    const coleta = this.value;
    const entrega = document.getElementById('data_entrega_prevista');
    if (coleta) {
        entrega.min = coleta;
        if (entrega.value && entrega.value <= coleta) {
            entrega.value = '';
        }
        
        // Validar hor√°rio de coleta solicitado
        const horarioSolicitado = '{{ frete.horario_coleta|default:"" }}';
        const dataSolicitada = '{{ frete.data_criacao|date:"Y-m-d" }}';
        console.log('Hor√°rio solicitado:', horarioSolicitado);
        console.log('Data solicitada:', dataSolicitada);
        console.log('Data coleta agendada:', coleta);
        
        if (horarioSolicitado && horarioSolicitado.trim() !== '') {
            try {
                // Extrair data e hora da coleta agendada
                const [dataAgendada, horaAgendada] = coleta.split('T');
                const [anoAgendada, mesAgendada, diaAgendada] = dataAgendada.split('-');
                const [horaAgendadaH, minutoAgendada] = horaAgendada.split(':');
                
                // Extrair data e hora solicitada
                const [anoSolicitada, mesSolicitada, diaSolicitada] = dataSolicitada.split('-');
                const [horaSolicitadaH, minutoSolicitada] = horarioSolicitado.split(':');
                
                // Criar objetos Date para compara√ß√£o completa
                const dataAgendadaObj = new Date(anoAgendada, mesAgendada - 1, diaAgendada, parseInt(horaAgendadaH), parseInt(minutoAgendada));
                const dataSolicitadaObj = new Date(anoSolicitada, mesSolicitada - 1, diaSolicitada, parseInt(horaSolicitadaH), parseInt(minutoSolicitada));
                
                console.log('Data agendada (Date):', dataAgendadaObj);
                console.log('Data solicitada (Date):', dataSolicitadaObj);
                console.log('Agendada > Solicitada:', dataAgendadaObj > dataSolicitadaObj);
                
                // Se o hor√°rio agendado for maior que o solicitado, mostrar aviso
                if (dataAgendadaObj > dataSolicitadaObj) {
                    const diferencaMs = dataAgendadaObj - dataSolicitadaObj;
                    const diferencaMinutos = Math.round(diferencaMs / (1000 * 60));
                    const diferencaHoras = Math.floor(diferencaMinutos / 60);
                    const diferencaDias = Math.floor(diferencaHoras / 24);
                    const horasRestantes = diferencaHoras % 24;
                    const minutosRestantes = diferencaMinutos % 60;
                    
                    // Formatar diferen√ßa
                    let diferencaTexto = '';
                    if (diferencaDias > 0) {
                        diferencaTexto += `${diferencaDias} dia${diferencaDias > 1 ? 's' : ''}`;
                        if (horasRestantes > 0 || minutosRestantes > 0) {
                            diferencaTexto += ', ';
                        }
                    }
                    if (horasRestantes > 0) {
                        diferencaTexto += `${horasRestantes} hora${horasRestantes > 1 ? 's' : ''}`;
                        if (minutosRestantes > 0) {
                            diferencaTexto += ' e ';
                        }
                    }
                    if (minutosRestantes > 0) {
                        diferencaTexto += `${minutosRestantes} minuto${minutosRestantes > 1 ? 's' : ''}`;
                    }
                    
                    // Formatar datas para exibi√ß√£o
                    const dataSolicitadaFormatada = `${diaSolicitada}/${mesSolicitada}/${anoSolicitada}`;
                    const dataAgendadaFormatada = `${diaAgendada}/${mesAgendada}/${anoAgendada}`;
                    
                    let mensagem = `‚ö†Ô∏è Data/Hor√°rio acima do solicitado!\n\n`;
                    mensagem += `Solicitado: ${dataSolicitadaFormatada} √†s ${horarioSolicitado}\n`;
                    mensagem += `Agendado: ${dataAgendadaFormatada} √†s ${horaAgendada}\n`;
                    mensagem += `Diferen√ßa: ${diferencaTexto}\n\n`;
                    mensagem += `Deseja continuar mesmo assim?`;
                    
                    console.log('Mostrando popup de valida√ß√£o');
                    if (!confirm(mensagem)) {
                        this.value = '';
                        return;
                    }
                } else {
                    console.log('Data/hor√°rio agendado √© menor ou igual ao solicitado - n√£o mostrar popup');
                }
            } catch (e) {
                console.log('Erro ao validar hor√°rio:', e);
            }
        } else {
            console.log('Nenhum hor√°rio solicitado encontrado');
        }
    }
});
</script>

<style>
/* Header Renner Styles */
.header-renner {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    position: relative;
    overflow: hidden;
}

.header-renner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    pointer-events: none;
}

.header-content {
    position: relative;
    z-index: 1;
    text-align: center;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.header-renner h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: white;
    text-shadow: 0 3px 6px rgba(0,0,0,0.3);
    letter-spacing: -0.02em;
}

.header-renner .subtitle {
    font-size: 1.125rem;
    opacity: 0.9;
    margin-bottom: 1rem;
    font-weight: 400;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .header-renner h1 {
        font-size: 2rem;
    }
    
    .header-renner .subtitle {
        font-size: 1rem;
    }
    
    .header-content {
        padding: 0 1rem;
    }
}

@media (max-width: 480px) {
    .header-renner h1 {
        font-size: 1.75rem;
    }
    
    .header-renner .subtitle {
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}
