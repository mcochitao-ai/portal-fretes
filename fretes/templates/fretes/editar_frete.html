{% extends 'fretes/base.html' %}
{% load static %}

{% block title %}Editar Frete #{{ frete.id }} - Portal de Fretes{% endblock %}

{% block content %}
<div class="container-md mt-8">
    <div class="card animate-fade-in">
        <div class="card-header">
            <h2>Editar Frete #{{ frete.id }}</h2>
            <p class="text-muted">Modifique as informa√ß√µes do frete conforme necess√°rio</p>
        </div>
        <div class="card-body">
            {% if erro %}
                <div class="alert alert-danger">{{ erro }}</div>
            {% endif %}
            
            <form method="post" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                
                <!-- Origem -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>üìç Origem</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="id_origem" class="form-label">Loja de Origem</label>
                            <select name="origem" id="id_origem" class="form-control" required>
                                <option value="">Selecione a loja...</option>
                                {% for id, nome, lat, lng in lojas_choices %}
                                    <option value="{{ id }}" data-lat="{{ lat }}" data-lng="{{ lng }}" 
                                            {% if frete.origem and frete.origem.id|stringformat:"s" == id %}selected{% endif %}>
                                        {{ nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="id_horario_coleta" class="form-label">Hor√°rio de Coleta</label>
                            <input type="datetime-local" name="horario_coleta" id="id_horario_coleta" 
                                   class="form-control" required value="{{ frete.horario_coleta|default:'' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="id_observacoes_origem" class="form-label">Observa√ß√µes da Coleta</label>
                            <textarea name="observacoes_origem" id="id_observacoes_origem" class="form-control" rows="3" 
                                      placeholder="Informe observa√ß√µes importantes para a coleta">{{ frete.observacoes_origem|default:'' }}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="id_anexo_origem" class="form-label">Anexo da Origem (Opcional)</label>
                            {% if frete.anexo_origem %}
                                <div class="mb-2 p-2 bg-light rounded">
                                    <small class="text-muted">Anexo atual: <strong>{{ frete.anexo_origem.name }}</strong></small>
                                    <a href="{{ frete.anexo_origem.url }}" target="_blank" class="btn btn-sm btn-outline ml-2">Ver</a>
                                </div>
                            {% endif %}
                            <input type="file" name="anexo_origem" id="id_anexo_origem" class="form-control" 
                                   accept=".xlsx,.xls,.pdf" onchange="validateFile(this)">
                            <div class="form-text">Formatos aceitos: Excel (.xlsx, .xls) e PDF (.pdf). Tamanho m√°ximo: 10MB</div>
                            <div id="file-error-origem" class="text-danger" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Destinos -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>üéØ Destinos</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="id_destino" class="form-label">Destino(s)</label>
                            <select name="destino" id="id_destino" class="form-control" multiple required>
                                {% for id, nome, lat, lng in lojas_choices %}
                                    <option value="{{ id }}" data-lat="{{ lat }}" data-lng="{{ lng }}"
                                            {% for destino in destinos_existentes %}
                                                {% if destino.loja == nome %}selected{% endif %}
                                            {% endfor %}>
                                        {{ nome }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Pressione Ctrl (ou Cmd no Mac) para selecionar m√∫ltiplos destinos</div>
                        </div>
                        
                        <div id="destinos-info"></div>
                    </div>
                </div>
                
                <!-- Bot√µes -->
                <div class="d-flex justify-content-between align-items-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        üíæ Salvar Altera√ß√µes
                    </button>
                    <a href="{% url 'frete_detalhe' frete.id %}" class="btn btn-outline btn-lg">
                        ‚ùå Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Valida√ß√£o de arquivo
function validateFile(input) {
    const file = input.files[0];
    const errorDiv = document.getElementById('file-error-origem');
    
    if (!file) {
        errorDiv.style.display = 'none';
        return;
    }
    
    // Verificar tamanho (10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB em bytes
    if (file.size > maxSize) {
        errorDiv.textContent = 'Arquivo muito grande. Tamanho m√°ximo permitido: 10MB';
        errorDiv.style.display = 'block';
        input.value = '';
        return;
    }
    
    // Verificar extens√£o
    const allowedExtensions = ['.xlsx', '.xls', '.pdf'];
    const fileName = file.name.toLowerCase();
    const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
    
    if (!hasValidExtension) {
        errorDiv.textContent = 'Formato n√£o permitido. Use apenas arquivos Excel (.xlsx, .xls) ou PDF (.pdf)';
        errorDiv.style.display = 'block';
        input.value = '';
        return;
    }
    
    errorDiv.style.display = 'none';
}

function atualizarCamposDestinos() {
    const select = document.getElementById('id_destino');
    const container = document.getElementById('destinos-info');
    container.innerHTML = '';
    
    Array.from(select.selectedOptions).forEach(option => {
        const id = option.value;
        const nome = option.text;
        
        // Buscar dados existentes do destino
        let volumeExistente = 1;
        let observacaoExistente = '';
        let anexoExistente = '';
        let dataEntregaExistente = '';
        
        {% for destino in destinos_existentes %}
            {% for id, nome, lat, lng in lojas_choices %}
                {% if destino.loja == nome %}
                    if (id === '{{ id }}') {
                        volumeExistente = {{ destino.volume|default:1 }};
                        observacaoExistente = '{{ destino.observacao|default:""|escapejs }}';
                        {% if destino.anexo_destino %}
                            anexoExistente = '{{ destino.anexo_destino.name|escapejs }}';
                        {% endif %}
                        {% if destino.data_entrega %}
                            dataEntregaExistente = '{{ destino.data_entrega|date:"Y-m-d\TH:i" }}';
                        {% endif %}
                    }
                {% endif %}
            {% endfor %}
        {% endfor %}
        
        const div = document.createElement('div');
        div.className = 'card mt-4';
        div.innerHTML = `
            <div class="card-header">
                <h5>${nome}</h5>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Endere√ßo</label>
                        <input type="text" id="destino_endereco_${id}" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√∫mero</label>
                        <input type="text" id="destino_numero_${id}" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Munic√≠pio</label>
                        <input type="text" id="destino_municipio_${id}" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <input type="text" id="destino_estado_${id}" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CEP</label>
                        <input type="text" id="destino_cep_${id}" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Volume</label>
                        <input type="number" min="1" name="volume_${id}" id="volume_${id}" class="form-control" required placeholder="Volume" value="${volumeExistente}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Entrega</label>
                        <input type="datetime-local" name="data_entrega_${id}" id="data_entrega_${id}" class="form-control" placeholder="Data e hor√°rio de entrega" value="${dataEntregaExistente}">
                    </div>
                </div>
                <div class="form-group mt-4">
                    <label class="form-label">Observa√ß√µes Espec√≠ficas</label>
                    <textarea name="observacao_${id}" id="observacao_${id}" class="form-control" rows="2" placeholder="Informa√ß√µes espec√≠ficas para este destino">${observacaoExistente}</textarea>
                </div>
                <div class="form-group mt-4">
                    <label class="form-label">Anexo do Destino (Opcional)</label>
                    ${anexoExistente ? `
                        <div class="mb-2 p-2 bg-light rounded">
                            <small class="text-muted">Anexo atual: <strong>${anexoExistente}</strong></small>
                        </div>
                    ` : ''}
                    <input type="file" name="anexo_destino_${id}" id="anexo_destino_${id}" class="form-control" accept=".xlsx,.xls,.pdf" onchange="validateFileDestino(this)">
                    <div class="form-text">Formatos aceitos: Excel (.xlsx, .xls) e PDF (.pdf). Tamanho m√°ximo: 10MB</div>
                    <div id="file-error-${id}" class="text-danger" style="display: none;"></div>
                </div>
            </div>
        `;
        
        container.appendChild(div);
        
        // Buscar dados da loja
        fetch('/loja-info/' + id + '/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('destino_endereco_' + id).value = data.endereco || '';
                document.getElementById('destino_numero_' + id).value = data.numero || '';
                document.getElementById('destino_municipio_' + id).value = data.municipio || '';
                document.getElementById('destino_estado_' + id).value = data.estado || '';
                document.getElementById('destino_cep_' + id).value = data.cep || '';
            });
    });
}

function validateFileDestino(input) {
    const file = input.files[0];
    const errorDiv = input.parentNode.querySelector('.text-danger');
    
    if (!file) {
        errorDiv.style.display = 'none';
        return;
    }
    
    // Verificar tamanho (10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB em bytes
    if (file.size > maxSize) {
        errorDiv.textContent = 'Arquivo muito grande. Tamanho m√°ximo permitido: 10MB';
        errorDiv.style.display = 'block';
        input.value = '';
        return;
    }
    
    // Verificar extens√£o
    const allowedExtensions = ['.xlsx', '.xls', '.pdf'];
    const fileName = file.name.toLowerCase();
    const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));
    
    if (!hasValidExtension) {
        errorDiv.textContent = 'Formato n√£o permitido. Use apenas arquivos Excel (.xlsx, .xls) ou PDF (.pdf)';
        errorDiv.style.display = 'block';
        input.value = '';
        return;
    }
    
    errorDiv.style.display = 'none';
}

document.getElementById('id_destino').addEventListener('change', atualizarCamposDestinos);
document.addEventListener('DOMContentLoaded', atualizarCamposDestinos);
</script>

<style>
.space-y-4 > * + * {
    margin-top: 1rem;
}

.d-flex {
    display: flex;
}

.justify-content-between {
    justify-content: space-between;
}

.align-items-center {
    align-items: center;
}

.gap-3 {
    gap: 1rem;
}

.grid {
    display: grid;
}

.grid-cols-1 {
    grid-template-columns: repeat(1, minmax(0, 1fr));
}

.grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
}

.gap-4 {
    gap: 1rem;
}

@media (min-width: 768px) {
    .md\:grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

.mt-4 {
    margin-top: 1rem;
}

.mb-2 {
    margin-bottom: 0.5rem;
}

.mb-4 {
    margin-bottom: 1rem;
}

.p-2 {
    padding: 0.5rem;
}

.bg-light {
    background-color: #f8f9fa;
}

.rounded {
    border-radius: 0.375rem;
}

.text-muted {
    color: #6c757d;
}

.ml-2 {
    margin-left: 0.5rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
}
</style>
{% endblock %}
