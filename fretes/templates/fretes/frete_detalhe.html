{% extends 'fretes/base.html' %}
{% load static %}
{% load frete_filters %}

{% block title %}Detalhes do Frete #{{ frete.id }} - Portal de Fretes Renner{% endblock %}

{% block content %}
<!-- Header -->
<div class="header header-renner">
    <div class="header-content">
        <h1>Detalhes do Frete #{{ frete.id }}</h1>
        <div class="subtitle">Visualize informações completas da solicitação</div>
    </div>
</div>

<!-- Main Content -->
<div class="container mt-8">
    <!-- Back Button and Actions -->
    <div class="mb-6 d-flex gap-3">
        <a href="/meus-fretes/" class="btn btn-outline">
            ← Voltar para Meus Fretes
        </a>
        {% if frete.status == 'pendente' and user.userprofile.pode_editar_fretes %}
            <a href="{% url 'editar_frete' frete.id %}" class="btn btn-warning">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Editar Frete
            </a>
        {% endif %}
    </div>

    <!-- Frete Info -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Info -->
        <div class="lg:col-span-2">
            <div class="card mb-6">
                <div class="card-header">
                    <h3>Informações Gerais</h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><strong>Solicitante:</strong> {{ frete.usuario.username }}</div>
                        <div><strong>Data Solicitação:</strong> {{ frete.data_criacao|date:'d/m/Y H:i' }}</div>
                        <div><strong>Horário de Coleta:</strong> {{ frete.horario_coleta|format_horario_coleta }}</div>
                        {% if frete.tipo_veiculo %}
                            <div><strong>Tipo de Veículo:</strong> 
                                {% if frete.tipo_veiculo == 'carreta' %}🚛 Carreta
                                {% elif frete.tipo_veiculo == 'truck' %}🚚 Truck
                                {% elif frete.tipo_veiculo == 'vuc' %}🚐 VUC
                                {% elif frete.tipo_veiculo == 'toco' %}🚛 Toco
                                {% elif frete.tipo_veiculo == '3_4' %}🚛 3/4
                                {% elif frete.tipo_veiculo == 'van' %}🚐 Van
                                {% else %}{{ frete.tipo_veiculo|title }}{% endif %}
                            </div>
                        {% endif %}
                        <div><strong>Status:</strong> 
                            {% if frete.status == 'pendente' %}
                                <span class="badge badge-pending">⏳ Pendente</span>
                            {% elif frete.status == 'cotacao_enviada' %}
                                <span class="badge badge-sent">📤 Cotação Enviada</span>
                            {% elif frete.status == 'finalizado' %}
                                <span class="badge badge-completed">✅ Finalizado</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Origem -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3>📍 Origem</h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><strong>Loja:</strong> {{ frete.origem.nome }}</div>
                        <div><strong>Endereço:</strong> {{ frete.origem.endereco }}, Nº {{ frete.origem.numero }}{% if frete.origem.complemento %}, {{ frete.origem.complemento }}{% endif %}</div>
                        <div><strong>Cidade:</strong> {{ frete.origem.municipio }}</div>
                        <div><strong>Estado:</strong> {{ frete.origem.estado }}</div>
                        <div><strong>CEP:</strong> {{ frete.origem.cep|format_cep }}</div>
                        <div><strong>Regional:</strong> {{ frete.origem.regional }}</div>
                    </div>
                    {% if frete.observacoes_origem %}
                        <div class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                            <h5 class="text-blue-800 font-semibold mb-2">📝 Observações da Coleta</h5>
                            <p class="text-blue-700">{{ frete.observacoes_origem }}</p>
                        </div>
                    {% endif %}
                    
                    {% if frete.anexo_origem %}
                        <div class="mt-4 p-3 bg-green-50 border-l-4 border-green-400 rounded">
                            <h5 class="text-green-800 font-semibold mb-2">📎 Anexo da Origem</h5>
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    {% if frete.anexo_origem.name|slice:"-4:" == ".pdf" %}
                                        <span class="text-red-600 text-2xl">📄</span>
                                    {% elif frete.anexo_origem.name|slice:"-5:" == ".xlsx" or frete.anexo_origem.name|slice:"-4:" == ".xls" %}
                                        <span class="text-green-600 text-2xl">📊</span>
                                    {% else %}
                                        <span class="text-gray-600 text-2xl">📎</span>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-green-700 font-medium truncate">{{ frete.anexo_origem.name }}</p>
                                    <p class="text-xs text-green-600">Arquivo anexado à origem</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <a href="{{ frete.anexo_origem.url }}" target="_blank" class="btn btn-sm btn-outline text-green-700 border-green-300 hover:bg-green-100">
                                        📥 Baixar
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Destinos -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3>🎯 Destinos</h3>
                </div>
                <div class="card-body">
                    {% for destino in destinos %}
                        <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:pb-0 last:mb-0">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><strong>Loja:</strong> {{ destino.loja|default:"-" }}</div>
                                <div><strong>Endereço:</strong> {{ destino.endereco|default:"-" }}{% if destino.numero %}, Nº {{ destino.numero }}{% endif %}</div>
                                <div><strong>Cidade:</strong> {{ destino.cidade|default:"-" }}</div>
                                <div><strong>Estado:</strong> {{ destino.estado|default:"-" }}</div>
                                <div><strong>CEP:</strong> {{ destino.cep|format_cep|default:"-" }}</div>
                                <div><strong>Volume:</strong> {{ destino.volume|default:"-" }}</div>
                                {% if destino.data_entrega %}
                                    <div><strong>Data de Entrega:</strong> {{ destino.data_entrega|date:'d/m/Y H:i' }}</div>
                                {% endif %}
                            </div>
                            {% if destino.observacao %}
                                <div class="mt-3 p-3 bg-green-50 border-l-4 border-green-400 rounded">
                                    <h6 class="text-green-800 font-semibold mb-1">📝 Observações Específicas</h6>
                                    <p class="text-green-700 text-sm">{{ destino.observacao }}</p>
                                </div>
                            {% endif %}
                            
                            {% if destino.anexo_destino %}
                                <div class="mt-3 p-3 bg-purple-50 border-l-4 border-purple-400 rounded">
                                    <h6 class="text-purple-800 font-semibold mb-2">📎 Anexo do Destino</h6>
                                    <div class="flex items-center space-x-3">
                                        <div class="flex-shrink-0">
                                            {% if destino.anexo_destino.name|slice:"-4:" == ".pdf" %}
                                                <span class="text-red-600 text-xl">📄</span>
                                            {% elif destino.anexo_destino.name|slice:"-5:" == ".xlsx" or destino.anexo_destino.name|slice:"-4:" == ".xls" %}
                                                <span class="text-green-600 text-xl">📊</span>
                                            {% else %}
                                                <span class="text-gray-600 text-xl">📎</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm text-purple-700 font-medium truncate">{{ destino.anexo_destino.name }}</p>
                                            <p class="text-xs text-purple-600">Arquivo anexado ao destino</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <a href="{{ destino.anexo_destino.url }}" target="_blank" class="btn btn-sm btn-outline text-purple-700 border-purple-300 hover:bg-purple-100">
                                                📥 Baixar
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p class="text-secondary">Nenhum destino cadastrado.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Transportadora -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3>🚛 Transportadora</h3>
                </div>
                <div class="card-body">
                    <form id="form-transportadora" method="post" class="space-y-4">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="form-label">Selecionar Transportadora</label>
                            <select id="transportadora-select" name="transportadora_id" class="form-control">
                                <option value="">Selecione...</option>
                                {% for t in transportadoras %}
                                    <option value="{{ t.id }}" data-email="{{ t.email }}" {% if frete.transportadora_selecionada and t.id == frete.transportadora_selecionada.id %}selected{% endif %}>{{ t.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Salvar</button>
                    </form>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <strong>Transportadora Selecionada:</strong><br>
                        {% if frete.transportadora_selecionada %}
                            {{ frete.transportadora_selecionada.nome }}
                        {% else %}
                            <span class="text-secondary">Nenhuma</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h3>⚡ Ações</h3>
                </div>
                <div class="card-body">
                    <div class="space-y-3">
                        <button type="button" id="enviar-email" class="btn btn-primary btn-block">
                            📧 Enviar Cotação por E-mail
                        </button>
                        
                        <button type="button" id="enviar-email-mailto" class="btn btn-secondary btn-block">
                            📮 Enviar pelo App de E-mail
                        </button>
                        
                        {% if frete.status != 'finalizado' %}
                            <button type="button" id="finalizar-frete" class="btn btn-success btn-block">
                                ✅ Finalizar Frete
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Instructions -->
    <div class="card mt-6">
        <div class="card-header">
            <h3>📋 Instruções para E-mail</h3>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <strong>Atenção:</strong> Se o botão de e-mail não abrir o e-mail pronto, é porque o Outlook Web não suporta essa função.
            </div>
            
            <p><strong>Solução:</strong> Copie o texto abaixo e cole manualmente em um novo e-mail para a transportadora.</p>
            
            <button onclick="copiarCorpoEmail()" class="btn btn-outline mt-3">
                📋 Copiar corpo do e-mail
            </button>
            
            <div id="corpo-email-preview" class="mt-4 p-4 bg-gray-50 rounded-lg font-mono text-sm whitespace-pre-line"></div>
        </div>
    </div>
</div>

<script id="dados-frete-json" type="application/json">
{
    "usuario": "{{ frete.usuario.username|escapejs }}",
    "origem": {
        "nome": "{{ frete.origem.nome|escapejs }}",
        "endereco": "{{ frete.origem.endereco|escapejs }}",
        "numero": "{{ frete.origem.numero|escapejs }}",
        "complemento": "{{ frete.origem.complemento|default_if_none:''|escapejs }}",
        "municipio": "{{ frete.origem.municipio|escapejs }}",
        "estado": "{{ frete.origem.estado|escapejs }}",
        "cep": "{{ frete.origem.cep|escapejs }}",
        "regional": "{{ frete.origem.regional|escapejs }}"
    },
    "data_solicitacao": "{{ frete.data_criacao|date:'d/m/Y H:i'|escapejs }}",
    "horario_coleta": "{{ frete.horario_coleta|format_horario_coleta|escapejs }}",
    "descricao": "{{ frete.descricao|default_if_none:'-'|escapejs }}",
    "destinos": [
    {% for destino in destinos %}
        {
            "loja": "{{ destino.loja|escapejs }}",
            "endereco": "{{ destino.endereco|escapejs }}",
            "numero": "{{ destino.numero|escapejs }}",
            "complemento": "{{ destino.complemento|default_if_none:''|escapejs }}",
            "cidade": "{{ destino.cidade|escapejs }}",
            "estado": "{{ destino.estado|escapejs }}",
            "cep": "{{ destino.cep|escapejs }}",
            "regional": "{{ destino.regional|escapejs }}",
            "volume": "{{ destino.volume|escapejs }}",
            "data_entrega": "{{ destino.data_entrega|date:'d/m/Y H:i'|default_if_none:''|escapejs }}"
        }{% if not forloop.last %},{% endif %}
    {% endfor %}
    ]
}
</script>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function montarCorpo() {
    const dadosFrete = JSON.parse(document.getElementById('dados-frete-json').textContent);
    const br = '\n';
    const br2 = '\n\n';
    let corpo = '';
    
    corpo += 'Solicitante: ' + dadosFrete.usuario + br2;
    corpo += 'Data Solicitação da Coleta: ' + (dadosFrete.data_solicitacao || '-') + br2;
    corpo += 'ORIGEM:' + br;
    corpo += '- Loja: ' + dadosFrete.origem.nome + br;
    corpo += '- Endereço: ' + dadosFrete.origem.endereco + ', Nº ' + dadosFrete.origem.numero;
    if (dadosFrete.origem.complemento) corpo += ', ' + dadosFrete.origem.complemento;
    corpo += br;
    corpo += '- Cidade: ' + dadosFrete.origem.municipio + br;
    corpo += '- Estado: ' + dadosFrete.origem.estado + br;
    corpo += '- CEP: ' + dadosFrete.origem.cep + br2;
    corpo += 'Horário de Coleta: ' + (dadosFrete.horario_coleta || '-') + br2;
    corpo += 'DESTINOS:' + br;
    
    for (let i = 0; i < dadosFrete.destinos.length; i++) {
        const d = dadosFrete.destinos[i];
        corpo += '- Loja: ' + (d.loja || '-') + br;
        corpo += '  Endereço: ' + (d.endereco || '-') + ', Nº ' + (d.numero || '-');
        if (d.complemento) corpo += ', ' + d.complemento;
        corpo += br;
        corpo += '  Cidade: ' + (d.cidade || '-') + br;
        corpo += '  Estado: ' + (d.estado || '-') + br;
        corpo += '  CEP: ' + (d.cep || '-') + br;
        corpo += '  Volume: ' + (d.volume || '-') + br2;
    }
    
    return corpo;
}

function atualizarStatusCotacao() {
    fetch('/frete/{{ frete.id }}/atualizar-status/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'status=cotacao_enviada'
    }).then(function(resp) {
        if (resp.ok) {
            setTimeout(function() { location.reload(); }, 400);
        }
    });
}

function atualizarStatusFinalizado() {
    fetch('/frete/{{ frete.id }}/atualizar-status/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'status=finalizado'
    }).then(function(resp) {
        if (resp.ok) {
            setTimeout(function() { location.reload(); }, 400);
        }
    });
}

function copiarCorpoEmail() {
    const corpo = montarCorpo();
    const temp = document.createElement('textarea');
    temp.value = corpo;
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    alert('Corpo do e-mail copiado!');
    atualizarStatusCotacao();
}

document.addEventListener('DOMContentLoaded', function() {
    // Preencher visualização do corpo do e-mail
    const corpoPreview = document.getElementById('corpo-email-preview');
    if (corpoPreview) corpoPreview.textContent = montarCorpo();
    
    // Event listeners
    const btnFinalizar = document.getElementById('finalizar-frete');
    if (btnFinalizar) {
        btnFinalizar.addEventListener('click', atualizarStatusFinalizado);
    }
    
    const btnOutlook = document.getElementById('enviar-email');
    if (btnOutlook) {
        btnOutlook.addEventListener('click', function() {
            const select = document.getElementById('transportadora-select');
            const selected = select.options[select.selectedIndex];
            const email = selected.getAttribute('data-email');
            
            if (!email) {
                alert('Selecione uma transportadora.');
                return;
            }
            
            const transportadoraNome = selected.textContent || selected.innerText;
            const corpo = montarCorpo();
            const lojaOrigem = 'Origem Loja {{ frete.origem.nome }}';
            const subject = 'Solicitação de Cotação de Frete - ' + lojaOrigem + ' - ' + transportadoraNome;
            const url = 'https://outlook.office.com/mail/deeplink/compose?popoutv2=1&to=' + encodeURIComponent(email) + '&subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(corpo) + '&bodyType=HTML';
            
            window.open(url, '_blank');
            atualizarStatusCotacao();
        });
    }
    
    const btnMailto = document.getElementById('enviar-email-mailto');
    if (btnMailto) {
        btnMailto.addEventListener('click', function() {
            const select = document.getElementById('transportadora-select');
            const selected = select.options[select.selectedIndex];
            const email = selected.getAttribute('data-email');
            
            if (!email) {
                alert('Selecione uma transportadora.');
                return;
            }
            
            const transportadoraNome = selected.textContent || selected.innerText;
            const corpo = montarCorpo();
            const lojaOrigem = 'Origem Loja {{ frete.origem.nome }}';
            const subject = 'Solicitação de Cotação de Frete - ' + lojaOrigem + ' - ' + transportadoraNome;
            const url = 'mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(corpo);
            
            window.location.href = url;
            atualizarStatusCotacao();
        });
    }
});
</script>

<style>
.space-y-3 > * + * {
    margin-top: 0.75rem;
}

.space-y-4 > * + * {
    margin-top: 1rem;
}

.border-b {
    border-bottom-width: 1px;
}

.border-gray-200 {
    border-color: var(--border-color);
}

.pb-4 {
    padding-bottom: 1rem;
}

.mb-4 {
    margin-bottom: 1rem;
}

.last\:border-b-0:last-child {
    border-bottom-width: 0;
}

.last\:pb-0:last-child {
    padding-bottom: 0;
}

.last\:mb-0:last-child {
    margin-bottom: 0;
}

.bg-gray-50 {
    background-color: var(--bg-secondary);
}

.font-mono {
    font-family: var(--font-mono);
}

.whitespace-pre-line {
    white-space: pre-line;
}

/* Anexos styles */
.bg-green-50 {
    background-color: #f0fdf4;
}

.bg-purple-50 {
    background-color: #faf5ff;
}

.border-green-400 {
    border-color: #4ade80;
}

.border-purple-400 {
    border-color: #a855f7;
}

.text-green-800 {
    color: #166534;
}

.text-green-700 {
    color: #15803d;
}

.text-green-600 {
    color: #16a34a;
}

.text-purple-800 {
    color: #6b21a8;
}

.text-purple-700 {
    color: #7c3aed;
}

.text-purple-600 {
    color: #9333ea;
}

.text-red-600 {
    color: #dc2626;
}

.text-gray-600 {
    color: #4b5563;
}

.flex {
    display: flex;
}

.items-center {
    align-items: center;
}

.space-x-3 > * + * {
    margin-left: 0.75rem;
}

.flex-shrink-0 {
    flex-shrink: 0;
}

.flex-1 {
    flex: 1 1 0%;
}

.min-w-0 {
    min-width: 0;
}

.truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
}

.border-green-300 {
    border-color: #86efac;
}

.border-purple-300 {
    border-color: #c4b5fd;
}

.hover\:bg-green-100:hover {
    background-color: #dcfce7;
}

.hover\:bg-purple-100:hover {
    background-color: #f3e8ff;
}

/* Edit button styles */
.d-flex {
    display: flex;
}

.gap-3 {
    gap: 0.75rem;
}

.btn-warning {
    background-color: #3b82f6;
    color: white;
    border: 1px solid #3b82f6;
}

.btn-warning:hover {
    background-color: #2563eb;
    border-color: #2563eb;
    color: white;
}

/* Renner Header Styles */
.header-renner {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    border-bottom: 3px solid #991b1b;
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
    text-align: center;
}

.header-renner h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: white;
    text-shadow: 0 3px 6px rgba(0,0,0,0.3);
    letter-spacing: -0.025em;
}

.header-renner .subtitle {
    font-size: 1.125rem;
    opacity: 0.9;
    margin-bottom: 1rem;
    font-weight: 400;
}


.user-greeting {
    font-size: 1rem;
    font-weight: 500;
    opacity: 0.9;
}

.logout-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    color: white;
    text-decoration: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .header-renner h1 {
        font-size: 2rem;
    }
    
    .header-renner .subtitle {
        font-size: 1rem;
    }
    
    .header-content {
        padding: 0 1rem;
    }
    
}

@media (max-width: 480px) {
    .header-renner h1 {
        font-size: 1.75rem;
    }
    
    .header-renner .subtitle {
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}
