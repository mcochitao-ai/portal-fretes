{% extends 'fretes/base.html' %}

{% block title %}Tracking - Frete #{{ frete.id }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="header mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">üöö Tracking - Frete #{{ frete.id }}</h1>
        <p class="text-gray-600">Acompanhe o status e localiza√ß√£o do seu frete em tempo real</p>
    </div>

    <!-- Informa√ß√µes do Frete -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 mb-8">
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Informa√ß√µes do Frete</h2>
                    <div class="space-y-3">
                        <div>
                            <span class="font-semibold text-gray-700">Solicitante:</span>
                            <span class="text-gray-600">{{ frete.usuario.get_full_name|default:frete.usuario.username }}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Origem:</span>
                            <span class="text-gray-600">
                                {% if frete.origem %}
                                    {{ frete.origem.nome }}
                                {% else %}
                                    N√£o informada
                                {% endif %}
                            </span>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Destinos:</span>
                            <div class="text-gray-600">
                                {% for destino in frete.destinos.all %}
                                    <div>{{ destino.cidade }}/{{ destino.estado }} (Vol: {{ destino.volume }})</div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if frete.valor_total %}
                            <div>
                                <span class="font-semibold text-gray-700">Valor Total:</span>
                                <span class="text-green-600 font-bold">R$ {{ frete.valor_total|floatformat:2 }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üöõ Dados do Ve√≠culo</h2>
                    <div class="space-y-3">
                        <div>
                            <span class="font-semibold text-gray-700">Placa:</span>
                            <span class="text-gray-600">{{ agendamento.placa_veiculo }}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Ve√≠culo:</span>
                            <span class="text-gray-600">{{ agendamento.veiculo_info }}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Motorista:</span>
                            <span class="text-gray-600">{{ agendamento.motorista_info }}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Data Coleta:</span>
                            <span class="text-gray-600">{{ agendamento.data_coleta|date:"d/m/Y H:i" }}</span>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Previs√£o Entrega:</span>
                            <span class="text-gray-600">{{ agendamento.data_entrega_prevista|date:"d/m/Y H:i" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Atual -->
    {% if status_atual %}
        <div class="bg-white rounded-lg shadow-md border border-gray-200 mb-8">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üìç Status Atual</h2>
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="text-4xl">{{ status_atual.status_icon }}</div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">{{ status_atual.get_status_display }}</h3>
                            {% if status_atual.localizacao_atual %}
                                <p class="text-gray-600">
                                    <strong>Localiza√ß√£o:</strong> {{ status_atual.localizacao_atual }}
                                </p>
                            {% endif %}
                            <p class="text-sm text-gray-500">
                                √öltima atualiza√ß√£o: {{ status_atual.data_atualizacao|date:"d/m/Y H:i" }}
                            </p>
                        </div>
                    </div>
                    {% if user.userprofile.is_transportadora or user.userprofile.is_usuario_master %}
                        <a href="{% url 'atualizar_tracking' frete.id %}" class="btn btn-primary">
                            Atualizar Status
                        </a>
                    {% endif %}
                </div>
                
                {% if status_atual.observacoes %}
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-700 mb-2">Observa√ß√µes:</h4>
                        <p class="text-gray-600">{{ status_atual.observacoes }}</p>
                    </div>
                {% endif %}
                
                {% if status_atual.tipo_problema %}
                    <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <h4 class="font-semibold text-red-700 mb-2">‚ö†Ô∏è Problema Reportado:</h4>
                        <p class="text-red-600"><strong>Tipo:</strong> {{ status_atual.tipo_problema }}</p>
                        {% if status_atual.descricao_problema %}
                            <p class="text-red-600 mt-2"><strong>Descri√ß√£o:</strong> {{ status_atual.descricao_problema }}</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Timeline de Tracking -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200">
        <div class="p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">üìà Hist√≥rico de Tracking</h2>
            
            {% if tracking_history %}
                <div class="space-y-6">
                    {% for tracking in tracking_history %}
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span class="text-lg">{{ tracking.status_icon }}</span>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-800">
                                        {{ tracking.get_status_display }}
                                    </h3>
                                    <span class="text-sm text-gray-500">
                                        {{ tracking.data_atualizacao|date:"d/m/Y H:i" }}
                                    </span>
                                </div>
                                
                                {% if tracking.localizacao_atual %}
                                    <p class="text-gray-600 mt-1">
                                        <strong>üìç Local:</strong> {{ tracking.localizacao_atual }}
                                    </p>
                                {% endif %}
                                
                                {% if tracking.observacoes %}
                                    <p class="text-gray-600 mt-1">
                                        <strong>üìù Observa√ß√µes:</strong> {{ tracking.observacoes }}
                                    </p>
                                {% endif %}
                                
                                {% if tracking.tipo_problema %}
                                    <div class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
                                        <p class="text-red-700">
                                            <strong>‚ö†Ô∏è Problema:</strong> {{ tracking.tipo_problema }}
                                        </p>
                                        {% if tracking.descricao_problema %}
                                            <p class="text-red-600 mt-1">{{ tracking.descricao_problema }}</p>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                
                                <p class="text-xs text-gray-400 mt-2">
                                    Atualizado por: {{ tracking.usuario_atualizacao.get_full_name|default:tracking.usuario_atualizacao.username }}
                                </p>
                            </div>
                        </div>
                        
                        {% if not forloop.last %}
                            <div class="ml-5 pl-4 border-l-2 border-gray-200"></div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-8">
                    <div class="text-gray-400 mb-4">
                        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Nenhum hist√≥rico dispon√≠vel</h3>
                    <p class="text-gray-500">O tracking ser√° atualizado conforme o progresso do frete.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Bot√µes de A√ß√£o -->
    <div class="flex justify-center gap-4 mt-8">
        <a href="{% url 'meus_fretes' %}" class="btn btn-outline">
            Voltar para Meus Fretes
        </a>
        {% if user.userprofile.is_transportadora or user.userprofile.is_usuario_master %}
            <a href="{% url 'atualizar_tracking' frete.id %}" class="btn btn-primary">
                Atualizar Status
            </a>
        {% endif %}
    </div>
</div>
{% endblock %}
