{% extends 'fretes/base.html' %}
{% load static %}
{% load frete_filters %}

{% block title %}Hist√≥rico de Cota√ß√µes - Portal de Fretes{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="text-center mb-0">üìä Hist√≥rico de Cota√ß√µes</h2>
                    <p class="text-center mb-0 opacity-75">
                        {% if user.userprofile.is_usuario_master %}
                            Todas as cota√ß√µes do sistema com acompanhamento de status
                        {% else %}
                            Acompanhe o status de todas as suas cota√ß√µes
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="card-body py-3">
            <div class="row justify-content-center">
                <div class="col-auto text-center">
                    <div class="d-flex flex-column align-items-center">
                        <div class="d-flex align-items-center mb-4">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                            <span class="text-muted">Gerencie e exporte suas cota√ß√µes</span>
                        </div>
                        <a href="{% url 'cotacoes_historico_transportadora_excel' %}" 
                           class="btn btn-success btn-lg d-flex align-items-center shadow-sm border-0 excel-export-btn" 
                           style="background: linear-gradient(135deg, #1d6f42 0%, #2d8f47 100%); border-radius: 12px; padding: 12px 24px; font-weight: 600; transition: all 0.3s ease; text-decoration: none;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="me-2" style="filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="#ffffff" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="14,2 14,8 20,8" fill="#ffffff" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 13H8" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 17H8" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="10,9 9,9 8,9" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span style="color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">Exportar Excel</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Estat√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-primary">Total</h5>
                    <h3 class="text-primary">{{ total_cotacoes }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-warning">Pendentes</h5>
                    <h3 class="text-warning">{{ pendentes }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">Enviadas</h5>
                    <h3 class="text-info">{{ enviadas }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-success">Aprovadas</h5>
                    <h3 class="text-success">{{ aprovadas }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-danger">Rejeitadas</h5>
                    <h3 class="text-danger">{{ rejeitadas }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title text-info">Valor Total</h5>
                    <h3 class="text-info">{{ valor_total_aprovadas|format_currency }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Cota√ß√µes -->
    {% if cotacoes %}
        <div class="card">
            <div class="card-header bg-light">
                <h4 class="mb-0 text-primary">üìã Hist√≥rico de Cota√ß√µes</h4>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-primary">
                            <tr>
                                <th>ID Frete</th>
                                <th>Transportadora</th>
                                <th>Solicitante</th>
                                <th>Origem</th>
                                <th>Destinos</th>
                                <th>Valor Total</th>
                                <th>Status</th>
                                <th>Aprovador</th>
                                <th>Data √öltima A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cotacao in cotacoes %}
                                <tr>
                                    <td><strong>#{{ cotacao.frete.id }}</strong></td>
                                    <td><strong>{{ cotacao.transportadora.nome }}</strong></td>
                                    <td>
                                        <strong>{{ cotacao.frete.usuario.username }}</strong>
                                        <small class="text-muted d-block">{{ cotacao.frete.usuario.email }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ cotacao.frete.origem.nome_loja }}</strong>
                                        <small class="text-muted d-block">{{ cotacao.frete.origem.municipio }}-{{ cotacao.frete.origem.estado }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ cotacao.frete.destinos.count }} destino(s)</strong>
                                        {% for destino in cotacao.frete.destinos.all %}
                                            <small class="text-muted d-block">{{ destino.municipio }}-{{ destino.estado }}</small>
                                        {% endfor %}
                                    </td>
                                    <td><strong class="text-success">{{ cotacao.valor_total|format_currency }}</strong></td>
                                    <td>
                                        {% if cotacao.status == 'pendente' %}
                                            <span class="badge bg-warning">Pendente</span>
                                        {% elif cotacao.status == 'enviada' %}
                                            <span class="badge bg-info">Enviada</span>
                                        {% elif cotacao.status == 'aprovada' %}
                                            <span class="badge bg-success">Aprovada</span>
                                        {% elif cotacao.status == 'rejeitada' %}
                                            <span class="badge bg-danger">Rejeitada</span>
                                        {% elif cotacao.status == 'rejeitada_transportadora' %}
                                            <span class="badge bg-secondary">Rejeitada pela Transportadora</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">{{ cotacao.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ cotacao.aprovador.username }}</strong>
                                        <small class="text-muted d-block">{{ cotacao.aprovador.email }}</small>
                                    </td>
                                    <td>
                                        {% if cotacao.data_aprovacao %}
                                            <strong>{{ cotacao.data_aprovacao|date:"d/m/Y" }}</strong>
                                            <small class="text-muted d-block">{{ cotacao.data_aprovacao|date:"H:i" }}</small>
                                        {% elif cotacao.data_cotacao %}
                                            <strong>{{ cotacao.data_cotacao|date:"d/m/Y" }}</strong>
                                            <small class="text-muted d-block">{{ cotacao.data_cotacao|date:"H:i" }}</small>
                                        {% else %}
                                            <strong>-</strong>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">Nenhuma cota√ß√£o encontrada</h4>
                <p class="text-muted">
                    {% if user.userprofile.is_usuario_master %}
                        N√£o h√° cota√ß√µes aprovadas ou rejeitadas no sistema.
                    {% else %}
                        Voc√™ ainda n√£o tem cota√ß√µes aprovadas ou rejeitadas.
                    {% endif %}
                </p>
                <a href="{% url 'fretes_para_cotacao' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-right me-2"></i>
                    Ir para Fretes para Cota√ß√£o
                </a>
            </div>
        </div>
    {% endif %}
</div>

<style>
.excel-export-btn:hover {
    background: linear-gradient(135deg, #2d8f47 0%, #1d6f42 100%) !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(45, 143, 71, 0.3) !important;
    text-decoration: none !important;
}

.excel-export-btn:active {
    transform: translateY(0);
    box-shadow: 0 4px 15px rgba(45, 143, 71, 0.2) !important;
}

.excel-export-btn svg {
    transition: transform 0.3s ease;
}

.excel-export-btn:hover svg {
    transform: scale(1.1);
}
</style>
{% endblock %}
