{% extends 'fretes/base.html' %}
{% load static %}

{% block title %}Dashboard - Portal de Fretes Renner{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilizar o bot√£o Sair da navbar no dashboard */
        .navbar-renner .logout-link {
            background: rgba(0, 0, 0, 0.1) !important;
            color: #000000 !important;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
        }
        
        .navbar-renner .logout-link:hover {
            background: #000000 !important;
            color: white !important;
            transform: translateY(-1px);
        }
        
        /* Adicionar informa√ß√£o do usu√°rio na navbar */
        .navbar-renner .user-greeting {
            color: #000000 !important;
            font-weight: 500;
            margin-right: 0.5rem;
        }
    </style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="header header-renner">
    <div class="header-content">
        <h1>Dashboard de Fretes</h1>
        <div class="subtitle">Visualize estat√≠sticas e relat√≥rios detalhados</div>
    </div>
</div>

<!-- Main Content -->
<div class="container mt-8">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="/" class="btn btn-outline">
            ‚Üê Voltar para o in√≠cio
        </a>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Fretes por M√™s - Gr√°fico de Linha -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">üìà Tend√™ncia de Fretes</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="fretesPorMes"></canvas>
                </div>
            </div>
        </div>

        <!-- Status dos Fretes -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">üìä Status dos Fretes</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="statusFretes"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Segunda linha de gr√°ficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Volumes por Destino -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">üéØ Volumes por Destino</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="volumesPorDestino"></canvas>
                </div>
            </div>
        </div>

        <!-- Fretes por Origem -->
        <div class="card">
            <div class="card-header">
                <h3 class="text-center">üìç Fretes por Origem</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="fretesPorOrigem"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°fico de An√°lise Temporal -->
    <div class="card mb-8">
        <div class="card-header">
            <h3 class="text-center">üìÖ An√°lise Temporal Detalhada</h3>
        </div>
        <div class="card-body">
                            <div class="chart-container-large">
                    <canvas id="analiseTemporal"></canvas>
                </div>
        </div>
    </div>

    <!-- Quick Stats -->
    {% if estatisticas %}
        <div class="card mt-8">
            <div class="card-header">
                <h3>Resumo Geral</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center p-6 bg-red-50 rounded-lg">
                        <div class="text-3xl font-bold text-red-600 mb-2">üì¶</div>
                        <div class="text-lg font-semibold text-gray-900">Total de Fretes</div>
                        <div class="text-2xl font-bold text-red-600">{{ estatisticas.total_fretes }}</div>
                    </div>
                    
                    <div class="text-center p-6 bg-red-50 rounded-lg">
                        <div class="text-3xl font-bold text-red-600 mb-2">‚è≥</div>
                        <div class="text-lg font-semibold text-gray-900">Pendentes</div>
                        <div class="text-2xl font-bold text-red-600">{{ estatisticas.fretes_pendentes }}</div>
                    </div>
                    
                    <div class="text-center p-6 bg-red-50 rounded-lg">
                        <div class="text-3xl font-bold text-red-600 mb-2">‚úÖ</div>
                        <div class="text-lg font-semibold text-gray-900">Conclu√≠dos</div>
                        <div class="text-2xl font-bold text-red-600">{{ estatisticas.fretes_finalizados }}</div>
                    </div>
                    
                    <div class="text-center p-6 bg-red-50 rounded-lg">
                        <div class="text-3xl font-bold text-red-600 mb-2">üìà</div>
                        <div class="text-lg font-semibold text-gray-900">Este M√™s</div>
                        <div class="text-2xl font-bold text-red-600">{{ estatisticas.fretes_mes }}</div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Debug: Mostrar por que n√£o est√° funcionando -->
        <div class="card mt-8">
            <div class="card-header">
                <h3>Debug - Por que as estat√≠sticas n√£o aparecem?</h3>
            </div>
            <div class="card-body">
                <div class="space-y-2">
                    <div><strong>Usu√°rio autenticado:</strong> {{ user.is_authenticated }}</div>
                    <div><strong>Username:</strong> {{ user.username }}</div>
                    <div><strong>Estat√≠sticas:</strong> {{ estatisticas }}</div>
                    <div><strong>User object:</strong> {{ user }}</div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Dados do Django -->
<div id="dashboard-data" style="display: none;">
    <div id="fretes-por-mes">{{ fretes_por_mes|safe }}</div>
    <div id="volumes-por-destino">{{ volumes_por_destino|safe }}</div>
    <div id="fretes-por-origem">{{ fretes_por_origem|safe }}</div>
    <div id="estatisticas-pendentes">{% if estatisticas %}{{ estatisticas.fretes_pendentes|default:0 }}{% else %}0{% endif %}</div>
    <div id="estatisticas-finalizados">{% if estatisticas %}{{ estatisticas.fretes_finalizados|default:0 }}{% else %}0{% endif %}</div>
    <div id="estatisticas-mes">{% if estatisticas %}{{ estatisticas.fretes_mes|default:0 }}{% else %}0{% endif %}</div>
</div>

<script>
// Dados do Django
const fretesPorMesData = JSON.parse(document.getElementById('fretes-por-mes').textContent);
const volumesPorDestinoData = JSON.parse(document.getElementById('volumes-por-destino').textContent);
const fretesPorOrigemData = JSON.parse(document.getElementById('fretes-por-origem').textContent);
const estatisticas = {
    fretes_pendentes: parseInt(document.getElementById('estatisticas-pendentes').textContent),
    fretes_finalizados: parseInt(document.getElementById('estatisticas-finalizados').textContent),
    fretes_mes: parseInt(document.getElementById('estatisticas-mes').textContent)
};

// Cores Renner
const rennerColors = {
    primary: '#dc2626',
    secondary: '#f3f4f6',
    success: '#16a34a',
    warning: '#d97706',
    info: '#2563eb',
    danger: '#dc2626'
};

// 1. Gr√°fico de Tend√™ncia Mensal (Linha)
const ctx1 = document.getElementById('fretesPorMes').getContext('2d');
new Chart(ctx1, {
    type: 'line',
    data: {
        labels: fretesPorMesData.labels,
        datasets: [{
            label: 'Fretes',
            data: fretesPorMesData.data,
            borderColor: rennerColors.primary,
            backgroundColor: rennerColors.primary + '20',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: '#e5e7eb'
                }
            },
            x: {
                grid: {
                    color: '#e5e7eb'
                }
            }
        }
    }
});

// 2. Gr√°fico de Status dos Fretes (Pizza)
const ctx2 = document.getElementById('statusFretes').getContext('2d');
new Chart(ctx2, {
    type: 'pie',
    data: {
        labels: ['Pendentes', 'Finalizados', 'Este M√™s'],
        datasets: [{
            data: [estatisticas.fretes_pendentes, estatisticas.fretes_finalizados, estatisticas.fretes_mes],
            backgroundColor: [rennerColors.warning, rennerColors.success, rennerColors.info],
            borderColor: 'white',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});

// 3. Gr√°fico de Volumes por Destino (Barras Horizontais)
const ctx3 = document.getElementById('volumesPorDestino').getContext('2d');
new Chart(ctx3, {
    type: 'bar',
    data: {
        labels: volumesPorDestinoData.labels,
        datasets: [{
            label: 'Volume',
            data: volumesPorDestinoData.data,
            backgroundColor: [
                rennerColors.primary,
                rennerColors.success,
                rennerColors.info,
                rennerColors.warning,
                '#7c3aed',
                '#0891b2',
                '#be123c',
                '#059669'
            ],
            borderColor: 'white',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: {
                    color: '#e5e7eb'
                }
            },
            y: {
                grid: {
                    color: '#e5e7eb'
                }
            }
        }
    }
});

// 4. Gr√°fico de Fretes por Origem (Rosca)
const ctx4 = document.getElementById('fretesPorOrigem').getContext('2d');
new Chart(ctx4, {
    type: 'doughnut',
    data: {
        labels: fretesPorOrigemData.labels,
        datasets: [{
            data: fretesPorOrigemData.data,
            backgroundColor: [
                rennerColors.primary,
                rennerColors.success,
                rennerColors.info,
                rennerColors.warning,
                '#7c3aed',
                '#0891b2',
                '#be123c',
                '#059669'
            ],
            borderColor: 'white',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '40%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});

// 5. An√°lise Temporal Detalhada (Gr√°fico de Barras)
const ctx5 = document.getElementById('analiseTemporal').getContext('2d');
new Chart(ctx5, {
    type: 'bar',
    data: {
        labels: fretesPorMesData.labels,
        datasets: [{
            label: 'Total de Fretes',
            data: fretesPorMesData.data,
            backgroundColor: rennerColors.primary,
            borderColor: 'white',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: '#e5e7eb'
                }
            },
            x: {
                grid: {
                    color: '#e5e7eb'
                }
            }
        }
    }
});

</script>

<style>
.bg-blue-50 { background-color: #eff6ff; }
.bg-yellow-50 { background-color: #fffbeb; }
.bg-green-50 { background-color: #f0fdf4; }
.bg-purple-50 { background-color: #faf5ff; }

.text-blue-600 { color: #2563eb; }
.text-yellow-600 { color: #d97706; }
.text-green-600 { color: #16a34a; }
.text-purple-600 { color: #9333ea; }

.text-gray-900 { color: #111827; }

.rounded-lg { border-radius: var(--radius-lg); }

.p-6 { padding: 1.5rem; }

.mb-2 { margin-bottom: 0.5rem; }

.text-3xl { font-size: 1.875rem; }
.text-2xl { font-size: 1.5rem; }
.text-lg { font-size: 1.125rem; }

/* Renner Color Classes */
.bg-red-50 { background-color: #fef2f2; }
.text-red-600 { color: #dc2626; }

/* Chart containers */
.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
    min-height: 400px;
    overflow: hidden;
}

/* Containers espec√≠ficos para gr√°ficos de pizza */
#statusFretes, #fretesPorOrigem {
    height: 350px !important;
    min-height: 350px !important;
}

.chart-container-large {
    position: relative;
    height: 500px;
    width: 100%;
    min-height: 500px;
    overflow: hidden;
}

/* Responsive chart heights */
@media (max-width: 1024px) {
    .chart-container {
        height: 350px;
        min-height: 350px;
    }
    
    .chart-container-large {
        height: 450px;
        min-height: 450px;
    }
    
    .card:has(.chart-container) {
        min-height: 450px;
    }
    
    .card:has(.chart-container-large) {
        min-height: 550px;
    }
    
    /* Gr√°ficos de pizza em tablet */
    #statusFretes, #fretesPorOrigem {
        height: 300px !important;
        min-height: 300px !important;
    }
}

@media (max-width: 768px) {
    .chart-container {
        height: 300px;
        min-height: 300px;
    }
    
    .chart-container-large {
        height: 350px;
        min-height: 350px;
    }
    
    .card:has(.chart-container) {
        min-height: 400px;
    }
    
    .card:has(.chart-container-large) {
        min-height: 450px;
    }
    
    /* Gr√°ficos de pizza em mobile */
    #statusFretes, #fretesPorOrigem {
        height: 250px !important;
        min-height: 250px !important;
    }
    
    /* Ajustar margens dos gr√°ficos em mobile */
    .card-body {
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .chart-container {
        height: 250px;
        min-height: 250px;
    }
    
    .chart-container-large {
        height: 300px;
        min-height: 300px;
    }
    
    .card:has(.chart-container) {
        min-height: 350px;
    }
    
    .card:has(.chart-container-large) {
        min-height: 400px;
    }
    
    /* Gr√°ficos de pizza em mobile pequeno */
    #statusFretes, #fretesPorOrigem {
        height: 200px !important;
        min-height: 200px !important;
    }
    
    /* Reduzir ainda mais o padding em telas muito pequenas */
    .card-body {
        padding: 0.75rem;
    }
    
    .card-header {
        padding: 1rem 1rem 0 1rem;
    }
}

/* Plotly specific styles */
.plotly-graph-div {
    border-radius: 8px;
}

/* Grid improvements */
.grid {
    display: grid;
    gap: 1.5rem;
}

.grid-cols-1 {
    grid-template-columns: repeat(1, minmax(0, 1fr));
}

@media (min-width: 1024px) {
    .lg\:grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

/* Card improvements */
.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid #e5e7eb;
    overflow: hidden;
    transition: all 0.3s ease;
    min-height: 500px;
}

.card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    transform: translateY(-2px);
}

.card-header {
    padding: 1.5rem 1.5rem 0 1.5rem;
    border-bottom: 1px solid #f3f4f6;
}

.card-body {
    padding: 1.5rem;
    overflow: hidden;
}

/* Cards espec√≠ficos para gr√°ficos */
.card:has(.chart-container) {
    min-height: 500px;
}

.card:has(.chart-container-large) {
    min-height: 600px;
}

/* Margin utilities */
.mb-8 {
    margin-bottom: 2rem;
}

/* Header Renner Styles */
.header-renner {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 3rem 0;
    text-align: center;
    box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
    position: relative;
    overflow: hidden;
}

.header-renner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.2;
}

.header-content {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}


.header-renner h1 {
    font-size: 3.5rem;
    font-weight: 800;
    margin-bottom: 0.75rem;
    color: white;
    text-shadow: 0 3px 6px rgba(0,0,0,0.3);
    letter-spacing: -0.02em;
}

.header-renner .subtitle {
    font-size: 1.5rem;
    opacity: 0.95;
    font-weight: 500;
    margin-bottom: 2rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .header-renner {
        padding: 2rem 0;
    }
    
    .header-renner h1 {
        font-size: 2.5rem;
    }
    
    .header-renner .subtitle {
        font-size: 1.25rem;
    }
}

@media (max-width: 480px) {
    .header-renner h1 {
        font-size: 2rem;
    }
    
    .header-renner .subtitle {
        font-size: 1rem;
    }
}
</style>
{% endblock %}

