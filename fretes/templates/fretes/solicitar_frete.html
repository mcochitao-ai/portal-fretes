<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Solicitar Frete</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .form-container { max-width: 500px; margin: 40px auto; background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h2 { text-align: center; margin-bottom: 24px; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; background: #007bff; color: #fff; border: none; padding: 10px; border-radius: 4px; font-size: 16px; }
        button:hover { background: #0056b3; }
        .btn-voltar { display: block; text-align: center; margin-top: 16px; color: #007bff; text-decoration: none; }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Solicitar Frete</h2>
        <form method="post">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_origem">Origem</label>
                <input type="text" id="pesquisa_origem" placeholder="Pesquisar loja..." style="margin-bottom:8px;">
                <select name="origem" id="id_origem" required>
                    <option value="">Selecione a loja de origem</option>
                    {% for id, nome, lat, lng in lojas_choices %}
                        <option value="{{ id }}" data-lat="{{ lat }}" data-lng="{{ lng }}">{{ nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="map" style="width:100%;height:300px;margin-bottom:16px;border-radius:8px;"></div>
            <div class="form-group">
                <label>Endereço</label>
                <input type="text" id="origem_endereco" readonly>
            </div>
            <div class="form-group">
                <label>Número</label>
                <input type="text" id="origem_numero" readonly>
            </div>
            <div class="form-group">
                <label>Município</label>
                <input type="text" id="origem_municipio" readonly>
            </div>
            <div class="form-group">
                <label>Estado</label>
                <input type="text" id="origem_estado" readonly>
            </div>
            <div class="form-group">
                <label>Latitude</label>
                <input type="text" id="origem_latitude" readonly>
            </div>
            <div class="form-group">
                <label>Longitude</label>
                <input type="text" id="origem_longitude" readonly>
            </div>
            <div class="form-group">
            <!-- Campos de destino, horário e descrição removidos desta tela -->
            <button type="submit">Avançar</button>
        </form>
        <a href="/" class="btn-voltar">Voltar</a>
    </div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var origemSelect = document.getElementById('id_origem');
            var pesquisaInput = document.getElementById('pesquisa_origem');
            // Mapa
            var map = L.map('map').setView([-14.235, -51.925], 4); // Centro do Brasil
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
            }).addTo(map);
            var marker;
            function atualizarMapaPorSelect() {
                var selected = origemSelect.options[origemSelect.selectedIndex];
                var lat = selected.getAttribute('data-lat');
                var lng = selected.getAttribute('data-lng');
                if (lat && lng && lat !== 'None' && lng !== 'None' && lat !== '' && lng !== '') {
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(map);
                    map.setView([lat, lng], 15);
                } else {
                    if (marker) map.removeLayer(marker);
                    map.setView([-14.235, -51.925], 4);
                }
            }
            if (origemSelect && pesquisaInput) {
                pesquisaInput.addEventListener('input', function() {
                    var filtro = this.value.toLowerCase();
                    for (var i = 0; i < origemSelect.options.length; i++) {
                        var option = origemSelect.options[i];
                        var texto = option.text.toLowerCase();
                        option.hidden = filtro && !texto.includes(filtro);
                    }
                    // Seleciona a primeira opção visível após o filtro e dispara o evento change
                    for (var i = 0; i < origemSelect.options.length; i++) {
                        if (!origemSelect.options[i].hidden) {
                            origemSelect.selectedIndex = i;
                            origemSelect.dispatchEvent(new Event('change'));
                            break;
                        }
                    }
                });
            }
            if (origemSelect) {
                origemSelect.addEventListener('change', function() {
                    var lojaId = this.value;
                    if (lojaId) {
                        fetch('/loja-info/' + lojaId + '/')
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('origem_endereco').value = data.endereco || '';
                                document.getElementById('origem_numero').value = data.numero || '';
                                document.getElementById('origem_municipio').value = data.municipio || '';
                                document.getElementById('origem_estado').value = data.estado || '';
                                document.getElementById('origem_latitude').value = data.latitude || '';
                                document.getElementById('origem_longitude').value = data.longitude || '';
                                // Atualiza o mapa
                                atualizarMapaPorSelect();
                            });
                    } else {
                        document.getElementById('origem_endereco').value = '';
                        document.getElementById('origem_numero').value = '';
                        document.getElementById('origem_municipio').value = '';
                        document.getElementById('origem_estado').value = '';
                        document.getElementById('origem_latitude').value = '';
                        document.getElementById('origem_longitude').value = '';
                        atualizarMapaPorSelect();
                    }
                });
                // Atualiza o mapa ao carregar a página
                atualizarMapaPorSelect();
            }
        });
    </script>
</body>
</html>
